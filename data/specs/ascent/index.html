<!DOCTYPE html>
<meta charset="utf-8">

<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
<script src="https://d3js.org/d3.v4.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>


<style>
#controls {
  position: absolute:
  top: 10px;
  left: 30px;
}
</style>
<body>
<div class="container-fluid">
    <div class="row">
      <div id="controls">
        <select class="custom-select" id="version_selector" onchange="update_graph(this)">
        </select>
     </div>
    </div>
    <div class="row">
        <div class="col-md-9" id="info">
        </div>
    </div>
    <div class="row">
        <div class="col-md-9">
          <div id="theplot"></div>
        </div>
        <div class="col-md-3">
            <ul class="list-group">
            <li class="list-group-item"><h4>1_package_name_overlap</h4>
              The shared packages over union of packages, regardless of version.</li>
	    <li class="list-group-item"><h4>2_package_name_version_exact</h4> 
	      The shared packages only with matching versions over union of packages.</li>
	    <li class="list-group-item"><h4>3_package_weighted_versions</h4> 
	      The shared packages accounting for version similarity, so more similar versions get a score closer to 1, over the union of packages.</li>
	    <li class="list-group-item"><h4>4_parameter_overlap</h4>
	      The shared number of same parameters over union of parameter options.</li>
	    <li class="list-group-item"><h4>5_arch_overlap</h4>
	      The shared arch features over union of all features.</li>
	    <li class="list-group-item">You can read more about the metrics <a href="https://github.com/vsoch/spack-changes/tree/main/data/specs#2-calculate-diffs" target="_blank">here</a></li>
         </ul>
        </div>
    </div>
</div>

<script>

var margin = {top: 120, right: 100, bottom: 150, left: 200},
    width = 900,
    height = 550;


// append the svg object to the body of the page
var svg = d3.select("#theplot")
.append("svg")
  .attr("width", width + margin.left + margin.right)
  .attr("height", height + margin.top + margin.bottom)
.append("g")
  .attr("transform",
        "translate(" + margin.left + "," + margin.top + ")");


function generate_plot(metric) {

  var data = window.data[metric];
  console.log(data);

  // Labels of row and columns -> spec1 and spec2
  var spec1 = d3.map(data, function(d){return d.spec1;}).keys()
  var spec2 = d3.map(data, function(d){return d.spec2;}).keys()

  // Build X scales and axis:
  var x = d3.scaleBand()
    .range([ 0, width ])
    .domain(spec1)
    .padding(0.05);
  svg.append("g")
    .style("font-size", 15)
    .attr("transform", "translate(0," + height + ")")
    .call(d3.axisBottom(x).tickSize(0))
    .selectAll("text")
      .attr("y", 0)
      .attr("x", -120)
      .attr("dy", ".35em")
      .attr("transform", "rotate(270)")
      .style("text-anchor", "start")
    .select(".domain").remove();


  // Build Y scales and axis:
  var y = d3.scaleBand()
    .range([ height, 0 ])
    .domain(spec2)
    .padding(0.05);
  svg.append("g")
    .style("font-size", 15)
    .call(d3.axisLeft(y).tickSize(0))
    .select(".domain").remove()

  // Build color scale
  // https://github.com/d3/d3-scale-chromatic
  var myColor = d3.scaleSequential()
    .interpolator(d3.interpolateBuPu)
    .domain([0,1])

  // create a tooltip
  var tooltip = d3.select("#info")
    .append("div")
    .style("opacity", 0)
    .attr("class", "tooltip")
    .style("background-color", "white")
    .style("border", "solid")
    .style("border-width", "2px")
    .style("border-radius", "5px")
    .style("padding", "5px")

  // Three function that change the tooltip when user hover / move / leave a cell
  var mouseover = function(d) {
    tooltip
      .style("opacity", 1)
    d3.select(this)
      .style("stroke", "black")
      .style("opacity", 0.5)
  }
  var mousemove = function(d) {
    tooltip
      .html(d.spec1 + " vs. " +  d.spec2 + ": <br>similarity score: " + Math.round(d.value * 1000) / 1000)
      .style("left", (d3.mouse(this)[0]+70) + "px")
      .style("top", (d3.mouse(this)[1]) + "px")
  }
  var mouseleave = function(d) {
    tooltip
      .style("opacity", 0)
    d3.select(this)
      .style("stroke", "none")
      .style("opacity", 0.8)
  }

  // add the squares
  svg.selectAll()
    .data(data, function(d) {return d.spec1+':'+d.spec2;})
    .enter()
    .append("rect")
      .attr("x", function(d) { return x(d.spec1) })
      .attr("y", function(d) { return y(d.spec2) })
      .attr("rx", 4)
      .attr("ry", 4)
      .attr("width", x.bandwidth() )
      .attr("height", y.bandwidth() )
      .style("cursor", "pointer")
      .style("fill", function(d) { return myColor(d.value)} )
      .style("stroke-width", 4)
      .style("stroke", "none")
      .style("opacity", 0.8)
    .on("mouseover", mouseover)
    .on("mousemove", mousemove)
    .on("mouseleave", mouseleave)
    .on("click", function(d){ document.location = "../compare.html?filename=" + d.spec1 + "-" + d.spec2 + "-comparison.json"})
}

// Add title to graph
svg.append("text")
        .attr("x", 0)
        .attr("y", -50)
        .attr("text-anchor", "left")
        .style("font-size", "22px")
        .text("Spec Change Over Time");

// Add subtitle to graph
svg.append("text")
        .attr("x", 0)
        .attr("y", -20)
        .attr("text-anchor", "left")
        .style("font-size", "14px")
        .style("fill", "grey")
        .style("max-width", 400)
        .text("Comparing specs generated by different versions of spack.");

// Change version on select change
update_graph = function(selector) {
   console.log(selector);
   generate_plot(selector.value);
}

d3.json("spec-diffs-vizdata.json", function(data) {
    window.data = data

    // We can cycle through different metrics
    var metrics = Object.keys(window.data);
    var selector = document.getElementById("version_selector");
    for (var i = 0; i < metrics.length; i++) {        
        var option = document.createElement("option");
        option.text = "Metric " + metrics[i];  
        option.value = metrics[i]
        selector.appendChild(option);
    }

    // 3_package_weighted_versions
    generate_plot(metrics[0])

});
</script>
